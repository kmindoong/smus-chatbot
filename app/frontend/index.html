<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>그룹웨어 메인 페이지</title>
    <link rel="stylesheet" href="style.css">
    
</head>
<body>

    <div class="main-content">
        <h1>그룹웨어 메인 페이지</h1>
        <p>우측 하단의 챗봇 아이콘을 클릭해 보세요.</p>
        <p>이 페이지는 .NET 포털을 시뮬레이션하는 순수 HTML입니다.</p>
    </div>

    <iframe 
        id="chatbot-frame"
        src="about:blank"
        frameborder="0"
        title="SMUS 봇">
    </iframe>

    <button id="chatbot-toggle-button-right" class="chatbot-toggle-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            <line x1="12" y1="11" x2="12" y2="11.01"></line>
            <line x1="8" y1="11" x2="8" y2="11.01"></line>
            <line x1="16" y1="11" x2="16" y2="11.01"></line>
        </svg>
    </button>
    <button id="chatbot-toggle-button-left" class="chatbot-toggle-button">
        <img src="./images/icon1.png" alt="챗봇 열기">
    </button>
    <button id="chatbot-toggle-button-center" class="chatbot-toggle-button">
        <img src="./images/icon2.png" alt="챗봇 열기">
    </button>

    <script>
        // 1. 필요한 HTML 요소들을 찾습니다.
        const chatbotFrame = document.getElementById('chatbot-frame');
        const chatbotToggleButtons = document.querySelectorAll('.chatbot-toggle-button');
        let CHATBOT_IFRAME_ORIGIN = '*'; // ⭐️ 기본값
        let CHATBOT_IFRAME_URL = ''; // ⭐️ 챗봇 URL 저장용

        // 3. 로그인 상태 확인 (localStorage 직접 확인)
        const cognitoIdToken = localStorage.getItem('CognitoIdToken'); 
        
        if (cognitoIdToken) {
            // 4-A. ⭐️ 토큰이 있으면: 버튼을 보여주고 리스너를 연결
            console.log("User is authenticated (Token found in localStorage).");
            
            // ⭐️ 1. 서버에서 챗봇 URL을 가져옵니다.
            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    CHATBOT_IFRAME_URL = config.chatbotUiUrl;
                    console.log("Setting iframe src to:", CHATBOT_IFRAME_URL);
                    
                    // ⭐️ 2. Iframe src를 *여기서* 설정합니다. (단, 클릭 시 로드)
                    // chatbotFrame.src = CHATBOT_IFRAME_URL; // (클릭 시 로드 방식으로 변경)
                    
                    // ⭐️ 3. CHATBOT_IFRAME_ORIGIN을 URL에서 추출합니다 (보안용)
                    try {
                        // URL이 http로 시작하는 절대 경로일 경우
                        const url = new URL(CHATBOT_IFRAME_URL);
                        CHATBOT_IFRAME_ORIGIN = url.origin;
                    } catch (e) {
                        // './chatbot.html' 같은 상대 경로일 경우
                        CHATBOT_IFRAME_ORIGIN = window.location.origin;
                    }

                    // ⭐️ 4. 버튼 리스너를 등록합니다.
                    let isIframeLoaded = false;
                    chatbotToggleButtons.forEach(btn => {
                        btn.addEventListener('click', () => {
                            // ⭐️ 5. [수정] 첫 클릭 시에만 iframe src를 설정 (성능 최적화)
                            if (!isIframeLoaded) {
                                chatbotFrame.src = CHATBOT_IFRAME_URL;
                                isIframeLoaded = true;
                            }
                            chatbotFrame.classList.toggle('visible');
                        });
                    });
                })
                .catch(err => {
                    console.error('Failed to fetch /api/config', err);
                    alert('챗봇 설정을 불러오는 데 실패했습니다.');
                });

        } else {
            console.log('Not authenticated (No token), redirecting to login.');
            window.location.href = 'login.html';
        }

        // 6. 챗봇(Iframe)과 토큰 교환
        window.addEventListener('message', (event) => {
            // ⭐️ [수정] CHATBOT_IFRAME_ORIGIN 변수 사용
            if (event.origin !== CHATBOT_IFRAME_ORIGIN) { 
                console.warn('Message from untrusted origin ignored:', event.origin, 'Expected:', CHATBOT_IFRAME_ORIGIN);
                return; 
            }

            if (event.data === 'chatbot-ready-for-token') {
                const currentToken = localStorage.getItem('CognitoIdToken'); 
                if (currentToken) {
                    chatbotFrame.contentWindow.postMessage({
                        type: 'cognito-id-token',
                        token: currentToken 
                    }, CHATBOT_IFRAME_ORIGIN); // ⭐️ '*' 대신 추출한 origin 사용
                } else {
                    window.location.href = 'login.html';
                }
            }
            
            if (event.data === 'close-chatbot') {
                chatbotFrame.classList.remove('visible');
            }
        });
    </script>
    
    </body>
</html>