<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>그룹웨어 메인 페이지</title>
    <link rel="stylesheet" href="style.css">
    
</head>
<body>

    <div class="main-content">
        <h1>그룹웨어 메인 페이지</h1>
        <p>우측 하단의 챗봇 아이콘을 클릭해 보세요.</p>
        <p>이 페이지는 .NET 포털을 시뮬레이션하는 순수 HTML입니다.</p>
    </div>
    <iframe 
        id="chatbot-frame"
        src="about:blank"
        frameborder="0"
        title="SMUS 봇">
    </iframe>
    <button id="chatbot-toggle-button-right" class="chatbot-toggle-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            <line x1="12" y1="11" x2="12" y2="11.01"></line>
            <line x1="8" y1="11" x2="8" y2="11.01"></line>
            <line x1="16" y1="11" x2="16" y2="11.01"></line>
        </svg>
    </button>
    <button id="chatbot-toggle-button-left" class="chatbot-toggle-button">
        <img src="./images/icon1.png" alt="챗봇 열기">
    </button>
    <button id="chatbot-toggle-button-center" class="chatbot-toggle-button">
        <img src="./images/icon2.png" alt="챗봇 열기">
    </button>

    <script>
        // ⭐️ [신규] 1. Cognito Hosted UI 콜백 처리
        function parseCognitoTokenFromUrl() {
            try {
                const hash = window.location.hash.substring(1); // URL의 # 제거
                const params = new URLSearchParams(hash);
                const idToken = params.get('id_token');
                
                if (idToken) {
                    console.log("Found ID token in URL hash. Saving to localStorage.");
                    localStorage.setItem('CognitoIdToken', idToken);
                    
                    // ⭐️ 토큰 정보를 URL에서 깨끗하게 제거
                    window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
                    return idToken;
                }
                return null;
            } catch (e) {
                console.error("Error parsing URL hash:", e);
                return null;
            }
        }

        // ⭐️ [신규] 페이지 로드 시 즉시 콜백 파싱 실행
        let cognitoIdToken = parseCognitoTokenFromUrl();

        // ⭐️ [수정] 2. 로컬 스토리지에서 다시 확인 (기존 로그인 유지)
        if (!cognitoIdToken) {
            cognitoIdToken = localStorage.getItem('CognitoIdToken'); 
        }

        // --- 3. (이하 로직은 기존과 거의 동일) ---
        const chatbotFrame = document.getElementById('chatbot-frame');
        const chatbotToggleButtons = document.querySelectorAll('.chatbot-toggle-button');
        let CHATBOT_IFRAME_ORIGIN = '*';
        let CHATBOT_IFRAME_URL = ''; 

        if (cognitoIdToken) {
            // 4-A. 토큰이 있으면: (기존 로직 동일)
            console.log("User is authenticated (Token found).");
            
            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    CHATBOT_IFRAME_URL = config.chatbotUiUrl;
                    console.log("Setting iframe src to:", CHATBOT_IFRAME_URL);
                    
                    try {
                        const url = new URL(CHATBOT_IFRAME_URL, window.location.origin);
                        CHATBOT_IFRAME_ORIGIN = url.origin;
                    } catch (e) {
                        CHATBOT_IFRAME_ORIGIN = window.location.origin;
                    }

                    let isIframeLoaded = false;
                    chatbotToggleButtons.forEach(btn => {
                        btn.addEventListener('click', () => {
                            if (!isIframeLoaded) {
                                chatbotFrame.src = CHATBOT_IFRAME_URL;
                                isIframeLoaded = true;
                            }
                            chatbotFrame.classList.toggle('visible');
                        });
                    });
                })
                .catch(err => {
                    console.error('Failed to fetch /api/config', err);
                    alert('챗봇 설정을 불러오는 데 실패했습니다.');
                });

        } else {
            // 4-B. ⭐️ 토큰이 없으면: login.html로 리디렉션 (기존과 동일)
            console.log('Not authenticated (No token), redirecting to login.');
            window.location.href = 'login.html';
        }

        // 6. 챗봇(Iframe)과 토큰 교환 (기존 로직 동일)
        window.addEventListener('message', (event) => {
            if (event.origin !== CHATBOT_IFRAME_ORIGIN) { 
                console.warn('Message from untrusted origin ignored:', event.origin, 'Expected:', CHATBOT_IFRAME_ORIGIN);
                return; 
            }
            if (event.data === 'chatbot-ready-for-token') {
                const currentToken = localStorage.getItem('CognitoIdToken'); 
                if (currentToken) {
                    chatbotFrame.contentWindow.postMessage({
                        type: 'cognito-id-token',
                        token: currentToken 
                    }, CHATBOT_IFRAME_ORIGIN);
                } else {
                    window.location.href = 'login.html';
                }
            }
            if (event.data === 'close-chatbot') {
                chatbotFrame.classList.remove('visible');
            }
        });
    </script>
    
    </body>
</html>